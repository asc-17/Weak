<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:Weak.Models"
    xmlns:selectors="clr-namespace:Weak.Selectors"
    xmlns:converters="clr-namespace:Weak.Converters"
    x:Class="Weak.Views.Onboarding.OnboardingPage"
    x:Name="OnboardingRoot"
    BackgroundColor="{StaticResource BackgroundLight}"
    NavigationPage.HasNavigationBar="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:BoolToColorConverter x:Key="BoolToColorConverter"/>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter"/>

            <DataTemplate x:Key="WelcomeTemplate">
                <VerticalStackLayout Spacing="20" Padding="40,0" VerticalOptions="Center">
                    <Label Text="〇" FontSize="72" HorizontalOptions="Center" TextColor="{StaticResource Primary}"/>
                    <Label Text="{Binding Title}" FontFamily="InterBold" FontSize="34"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextPrimaryLight}"/>
                    <Label Text="{Binding Subtitle}" FontFamily="InterRegular" FontSize="17"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextSecondaryLight}"/>
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="NameTemplate">
                <VerticalStackLayout Spacing="24" Padding="40,0" VerticalOptions="Center">
                    <Label Text="{Binding Title}" FontFamily="InterBold" FontSize="28"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextPrimaryLight}"/>
                    <Border StrokeShape="RoundRectangle 12" Stroke="{StaticResource Gray200}"
                            StrokeThickness="1" BackgroundColor="White" Padding="16,12">
                        <Entry Text="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.UserName}"
                               Placeholder="e.g., Alex" FontFamily="InterRegular" FontSize="16"
                               PlaceholderColor="{StaticResource Gray400}"
                               TextColor="{StaticResource TextPrimaryLight}"
                               BackgroundColor="Transparent"/>
                    </Border>
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="TimesTemplate">
                <VerticalStackLayout Spacing="20" Padding="40,0" VerticalOptions="Center">
                    <Label Text="{Binding Title}" FontFamily="InterBold" FontSize="28"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextPrimaryLight}"/>
                    <Label Text="{Binding Subtitle}" FontFamily="InterRegular" FontSize="15"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextSecondaryLight}"/>
                    <Border StrokeShape="RoundRectangle 12" Stroke="{StaticResource Gray200}"
                            StrokeThickness="1" BackgroundColor="White" Padding="16,12">
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Wake Up" FontFamily="InterMedium" FontSize="16"
                                   TextColor="{StaticResource TextPrimaryLight}" VerticalOptions="Center"/>
                            <TimePicker Grid.Column="1"
                                        Time="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.WakeTime, Mode=TwoWay}"
                                        TextColor="{StaticResource Primary}" FontFamily="InterMedium" FontSize="16"/>
                        </Grid>
                    </Border>
                    <Border StrokeShape="RoundRectangle 12" Stroke="{StaticResource Gray200}"
                            StrokeThickness="1" BackgroundColor="White" Padding="16,12">
                        <Grid ColumnDefinitions="*, Auto">
                            <Label Text="Sleep" FontFamily="InterMedium" FontSize="16"
                                   TextColor="{StaticResource TextPrimaryLight}" VerticalOptions="Center"/>
                            <TimePicker Grid.Column="1"
                                        Time="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.SleepTime, Mode=TwoWay}"
                                        TextColor="{StaticResource Primary}" FontFamily="InterMedium" FontSize="16"/>
                        </Grid>
                    </Border>
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="WeekStartTemplate">
                <VerticalStackLayout Spacing="28" Padding="40,0" VerticalOptions="Center">
                    <Label Text="{Binding Title}" FontFamily="InterBold" FontSize="28"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextPrimaryLight}"/>
                    <HorizontalStackLayout HorizontalOptions="Center" Spacing="16">
                        <Button Text="Sunday"
                                Command="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.SetWeekStartCommand}"
                                CommandParameter="sunday"
                                BackgroundColor="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.IsSundaySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=primary}"
                                TextColor="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.IsSundaySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=text}"
                                FontFamily="InterSemiBold" CornerRadius="24" HeightRequest="52" WidthRequest="130"/>
                        <Button Text="Monday"
                                Command="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.SetWeekStartCommand}"
                                CommandParameter="monday"
                                BackgroundColor="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.IsMondaySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=primary}"
                                TextColor="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.IsMondaySelected, Converter={StaticResource BoolToColorConverter}, ConverterParameter=text}"
                                FontFamily="InterSemiBold" CornerRadius="24" HeightRequest="52" WidthRequest="130"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="GoogleTemplate">
                <VerticalStackLayout Spacing="16" Padding="40,0" VerticalOptions="Center">
                    <Label Text="{Binding Title}" FontFamily="InterBold" FontSize="28"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextPrimaryLight}"/>
                    <Label Text="{Binding Subtitle}" FontFamily="InterRegular" FontSize="15"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextSecondaryLight}"/>
                    <Button Text="Connect Google Calendar"
                            Command="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.ConnectGoogleCommand}"
                            BackgroundColor="{StaticResource Primary}" TextColor="White"
                            FontFamily="InterSemiBold" CornerRadius="12" HeightRequest="52" Margin="0,12,0,0"/>
                    <Button Text="Skip for now"
                            Command="{Binding Source={x:Reference OnboardingRoot}, Path=BindingContext.SkipCommand}"
                            BackgroundColor="Transparent" TextColor="{StaticResource TextSecondaryLight}"
                            FontFamily="InterRegular" BorderWidth="0"/>
                </VerticalStackLayout>
            </DataTemplate>

            <DataTemplate x:Key="DoneTemplate">
                <VerticalStackLayout Spacing="16" Padding="40,0" VerticalOptions="Center">
                    <Label Text="✓" FontSize="64" HorizontalOptions="Center" TextColor="{StaticResource Primary}"/>
                    <Label Text="{Binding Title}" FontFamily="InterBold" FontSize="32"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextPrimaryLight}"/>
                    <Label Text="{Binding Subtitle}" FontFamily="InterRegular" FontSize="16"
                           HorizontalTextAlignment="Center" TextColor="{StaticResource TextSecondaryLight}"/>
                </VerticalStackLayout>
            </DataTemplate>

            <selectors:OnboardingTemplateSelector x:Key="OnboardingSelector"
                WelcomeTemplate="{StaticResource WelcomeTemplate}"
                NameTemplate="{StaticResource NameTemplate}"
                TimesTemplate="{StaticResource TimesTemplate}"
                WeekStartTemplate="{StaticResource WeekStartTemplate}"
                GoogleTemplate="{StaticResource GoogleTemplate}"
                DoneTemplate="{StaticResource DoneTemplate}"/>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="*, Auto, Auto" Padding="0,56,0,48">

        <CarouselView Grid.Row="0"
                      ItemsSource="{Binding Steps}"
                      CurrentItem="{Binding CurrentStep}"
                      IsSwipeEnabled="False"
                      HorizontalScrollBarVisibility="Never"
                      VerticalScrollBarVisibility="Never"
                      Loop="False">
            <CarouselView.ItemTemplate>
                <selectors:OnboardingTemplateSelector
                    WelcomeTemplate="{StaticResource WelcomeTemplate}"
                    NameTemplate="{StaticResource NameTemplate}"
                    TimesTemplate="{StaticResource TimesTemplate}"
                    WeekStartTemplate="{StaticResource WeekStartTemplate}"
                    GoogleTemplate="{StaticResource GoogleTemplate}"
                    DoneTemplate="{StaticResource DoneTemplate}"/>
            </CarouselView.ItemTemplate>
        </CarouselView>

        <HorizontalStackLayout Grid.Row="1"
                               HorizontalOptions="Center"
                               Spacing="8"
                               Margin="0,20,0,20"
                               BindableLayout.ItemsSource="{Binding Steps}">
            <BindableLayout.ItemTemplate>
                <DataTemplate x:DataType="models:OnboardingStep">
                    <Border HeightRequest="8" WidthRequest="8"
                            StrokeShape="Ellipse" StrokeThickness="0"
                            BackgroundColor="{Binding IsActive, Converter={StaticResource BoolToColorConverter}, ConverterParameter=primary}"/>
                </DataTemplate>
            </BindableLayout.ItemTemplate>
        </HorizontalStackLayout>

        <Grid Grid.Row="2" ColumnDefinitions="Auto, *" Padding="24,0" ColumnSpacing="12">
            <Button Grid.Column="0"
                    Text="Back"
                    Command="{Binding BackCommand}"
                    IsVisible="{Binding IsFirstStep, Converter={StaticResource InverseBoolConverter}}"
                    BackgroundColor="{StaticResource Gray100}"
                    TextColor="{StaticResource TextSecondaryLight}"
                    FontFamily="InterMedium"
                    CornerRadius="12"
                    HeightRequest="52"
                    WidthRequest="84"/>
            <Button Grid.Column="1"
                    Text="{Binding NextButtonText}"
                    Command="{Binding NextCommand}"
                    BackgroundColor="{StaticResource Primary}"
                    TextColor="White"
                    FontFamily="InterSemiBold"
                    CornerRadius="12"
                    HeightRequest="52"/>
        </Grid>

    </Grid>
</ContentPage>
